/*
 Faz uma comunicação com um determininado host na rede, essa comunicação pode prosseguir, ou não.

 By Fabiano Santos

    //Em construção
*/


#include <stdio.h>
//#include <netdb.h>
#include <arpa/inet.h>    // htons(), inet_addr()
#include <netinet/in.h>// struct sockaddr_in
#include <sys/socket.h>// socket() connect()
#include <sys/types.h>// AF_INET, SOCK_STREAM
#include <unistd.h>// close()

int main(int argc, char *argv[]){

    int meusocket;
    int conecta;//Reliaza a conexão

    int porta;
    int inicio = 0;
    int final = 65535;
    char *destino;
    destino = argv[1];//Destino recebe o que o usuário passar como primeiro argumento  

    printf(" ##############################################################################\n");
    printf("#                                                                              #\n");
    printf("#   ######  #####  #####  #######     ######  ######      ##       #    #      #\n");
    printf("#   #    #  #   #  #   #     #        #       #          #  #      ##   #      #\n");
    printf("#   #####   #   #  ####      #        ######  #         ######     # #  #      #\n");
    printf("#   #       #   #  # #       #             #  #        #      #    #  # #      #\n");
    printf("#   #       #####  #  #      #        ######  ######  #        #   #   ##      #\n");
    printf("#                                                                              #\n");
    printf("# Versão: 1.0                                                                  #\n");
    printf("# By: Fabiano Santos                                                           #\n");
    printf(" ##############################################################################\n\n");

    struct sockaddr_in alvo;// Estrutura responsável pela conexão com a internet

    //Laço para range de portas
    for(porta = inicio; porta < final; porta++){

    meusocket = socket(AF_INET, SOCK_STREAM, 0);//AF_INET- Familia Arpanet Internet Protocol/* 0 é o protocolo ip*/
    alvo.sin_family = AF_INET;// A estrutura vai utilizar a familia AF_INET
    alvo.sin_port = htons(porta);//Faz a comunicação com a porta 80 do alvo'
    alvo.sin_addr.s_addr = inet_addr(destino);// Endereço do alvo da conexão

    conecta = connect(meusocket, (struct sockaddr *)&alvo, sizeof alvo);//Faz a conexão com o alvo

    /*Testa se a conexão foi bem sucedida com o alvo. Se retornar 0, a porta esta aberta,
     se retornar -1 a porta está fechada*/
    if(conecta == 0)
    {
         printf("Host %s Porta %d - status [aberta] \n",destino, porta);
         close(meusocket);//Fecha o socket
         close(conecta);//Fecha o conecta
    }
    else{
         close(meusocket);
         close(conecta);

    }
    

    }
return 0;
}
